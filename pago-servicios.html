<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pago de Servicios - The Pokemon Bank</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <!-- Iconos -->
  <link href="assets/css/main.css" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/98424cc025.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

  <!-- SweetAlert2 -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- validate.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/validate.js/0.13.1/validate.min.js"></script>

  <!-- Page styles -->
   <link rel="stylesheet" href="../demoChartjs-pagoServicios-footer/estilos.css" />

  <style>
    body { background-image: url("../assets/img/bg.png"); }
    .app-shell { max-width: 1000px; min-height: 100vh; background: #fff; margin: 0 auto; }
    .section-border { border-top: 4px solid var(--bs-danger); }

    .modal, .modal-backdrop { position: fixed !important; }
    .modal-open .app-shell { overflow: visible !important; }
  </style>

  <!-- LOGIN PROTECTION -->
  <script>
    function requireLogin() {
        const usuario = JSON.parse(localStorage.getItem('usuario') || '{}');
        if (!usuario || usuario.login !== true) {
            window.location.href = "index.html";
            throw new Error("Not logged in");
        }
    }
    requireLogin();
  </script>
</head>

<body class="bg-light">

<div class="app-shell">

  <!-- Header -->
  <header class="bg-danger text-white p-3 d-flex align-items-center justify-content-between sticky-top shadow">
      <a href="../panel.html" class="fw-bold fs-5 d-flex align-items-center text-decoration-none text-white">
          <img src="assets/img/pokeball.png" alt="Pokeball" style="height:32px; margin-right: 8px;">
          ThePokeBank
      </a>
      <button id="btnSalir" class="btn btn-sm btn-outline-light">Salir</button>
  </header>

  <main class="p-3">

      <!-- Top panel: Cuenta + Saldo -->
      <div class="section-border mb-4">
        <div class="p-3 bg-body-tertiary">
            <div class="d-flex align-items-start">
                <i class="fa-duotone fa-solid fa-piggy-bank fs-3 me-3"></i>
                <div>
                    <span class="fw-semibold me-2" id="cuenta"></span>
                    <span>Cuenta de ahorros</span>
                    <div class="py-3 fw-semibold fs-3" id="saldo"></div>
                    <span class="text-secondary small">Saldo disponible</span>
                </div>
            </div>
        </div>
      </div>

      <!-- Title -->
      <h2 class="fw-bold text-dark mb-1">
        <i class="fa-duotone fa-solid fa-comment-dollar me-2"></i> Pago de Servicios
      </h2>
      <p class="text-muted">Realice el pago de sus servicios de forma rápida y segura</p>

      <!-- Categories -->
      <div class="card border-0 mb-4">
        <div class="card-header bg-white py-3">
            <h5 class="fw-bold">Seleccione una categoría</h5>
        </div>

        <div class="card-body">

          <!-- ENERGÍA -->
          <div class="mb-3">
            <button class="btn btn-outline-danger w-100 d-flex justify-content-between"
                type="button" data-bs-toggle="collapse" data-bs-target="#listaEnergia">
                <span><i class="fa-duotone fa-solid fa-bolt me-2"></i> Energía Eléctrica</span>
                <i class="bi bi-chevron-down"></i>
            </button>

            <div class="collapse mt-2" id="listaEnergia">

                <a href="#" class="list-group-item service-item"
                   data-bs-toggle="modal" data-bs-target="#modalPago"
                   data-categoria="Energía Eléctrica" data-empresa="CAESS">
                   CAESS
                </a>

                <a href="#" class="list-group-item service-item"
                   data-bs-toggle="modal" data-bs-target="#modalPago"
                   data-categoria="Energía Eléctrica" data-empresa="CLESSA">
                   CLESSA
                </a>

                <a href="#" class="list-group-item service-item"
                   data-bs-toggle="modal" data-bs-target="#modalPago"
                   data-categoria="Energía Eléctrica" data-empresa="DEL SUR">
                   DEL SUR
                </a>

            </div>
          </div>

          <!-- AGUA -->
          <div class="mb-3">
            <button class="btn btn-outline-danger w-100 d-flex justify-content-between"
                type="button" data-bs-toggle="collapse" data-bs-target="#listaAgua">
                <span><i class="fa-duotone fa-solid fa-droplet me-2"></i> Agua Potable</span>
                <i class="bi bi-chevron-down"></i>
            </button>

            <div class="collapse mt-2" id="listaAgua">

                <a href="#" class="list-group-item service-item"
                   data-bs-toggle="modal" data-bs-target="#modalPago"
                   data-categoria="Agua Potable" data-empresa="ANDA">
                   ANDA
                </a>

            </div>
          </div>

        </div>
      </div>

      <div class="alert alert-warning">
        <i class="bi bi-info-circle"></i> Pagos después de las 6 PM se procesan al siguiente día hábil.
      </div>
  </main>
<footer class="custom-footer mt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-4 mb-4 mb-md-0">
        <h4 class="fw-bold mb-3">The Pokemon Bank</h4>
        <p class="somos mb-0">
          TPB es una institución financiera a tu servicio, ofreciendo las
          mejores soluciones bancarias para entrenadores Pokémon.
        </p>
        <div class="mt-0 mb-0">
          <img src="../assets/img/logo_pdf.png" alt="The Pokemon Bank" class="img-fluid" style="max-height: 100px;">
        </div>
      </div>

      <div class="col-md-4 mb-4 mb-md-0">
        <h4 class="fw-bold mb-3">Enlaces útiles</h4>
        <ul>
          <li><a href="#" class="link">Contacto y Sugerencias</a></li>
          <li><a href="#" class="link">Política de privacidad</a></li>
          <li><a href="#" class="link">FAQ</a></li>
          <li><a href="#" class="link">Términos y condiciones</a></li>
          <li><a href="#" class="link">Tasas & Comisiones</a></li>
        </ul>
      </div>

      <div class="col-md-4">
        <h4 class="fw-bold mb-3">Síguenos</h4>
        <div class="social-icons d-flex gap-3">
          <a class="link" href="https://x.com/" target="_blank" rel="noopener noreferrer">
            <i class="fa-brands fa-x-twitter fa-lg"></i>
          </a>
          <a class="link" href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-facebook fa-lg"></i>
          </a>
          <a class="link" href="https://www.youtube.com/" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-youtube fa-lg"></i>
          </a>
          <a class="link" href="https://instagram.com" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-instagram fa-lg"></i>
          </a>
        </div>
      </div>
    </div>
  </div>
  
  <div class="footer-bottom text-center mt-4">
    <div class="container">
      <p class="mb-0">Todos los derechos reservados. TPB / EquipoDAW 2025 &copy;</p>
    </div>
  </div>
</footer>
</div>


<!-- Modal Pago -->
<div class="modal fade" id="modalPago" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Pagar Servicio</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <form id="pagoServicioForm">

          <div class="mb-3">
            <label class="form-label">Servicio Seleccionado</label>
            <input type="text" id="servicioSeleccionado" class="form-control" readonly>
          </div>

          <div class="mb-3">
            <label class="form-label">Referencia</label>
            <input type="text" id="referenciaInput" class="form-control"
                   placeholder="XXXX-XXX-XXXX"
                   pattern="^\d{4}-\d{3}-\d{4}$" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Monto a pagar</label>
            <input type="text" id="montoInput" class="form-control"
                   inputmode="decimal" placeholder="0.00">
          </div>

          <div id="saldoActual" class="text-muted small"></div>

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" onclick="aplicarPago()">Aplicar Pago</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<!-- MAIN PAGE SCRIPT -->
<script>
let selectedCategory = "";
let selectedCompany = "";

/* LOAD USER INFO */
document.addEventListener("DOMContentLoaded", () => {
    const usuario = JSON.parse(localStorage.getItem("usuario"));
    document.getElementById("cuenta").textContent = usuario.cuenta;
    document.getElementById("saldo").textContent = "$" + usuario.saldo.toFixed(2);

    // Logout
    document.getElementById("btnSalir").addEventListener("click", () => {
        usuario.login = false;
        localStorage.setItem("usuario", JSON.stringify(usuario));
        location.href = "index.html";
    });

    // Service selection
    document.querySelectorAll(".service-item").forEach(btn => {
        btn.addEventListener("click", () => {
            selectedCategory = btn.dataset.categoria;
            selectedCompany = btn.dataset.empresa;

            document.getElementById("servicioSeleccionado").value =
                `${selectedCategory} - ${selectedCompany}`;
        });
    });

    // Modal saldo
    document.getElementById('modalPago').addEventListener('show.bs.modal', () => {
        const usuario = JSON.parse(localStorage.getItem("usuario"));
        document.getElementById('saldoActual').textContent =
            "Saldo actual: $" + usuario.saldo.toFixed(2);
        document.getElementById('pagoServicioForm').reset();
        document.getElementById("servicioSeleccionado").value =
            `${selectedCategory} - ${selectedCompany}`;
    });
});

/* APPLY PAYMENT */
function aplicarPago() {
    const usuario = JSON.parse(localStorage.getItem("usuario"));

    const data = {
        referencia: document.getElementById("referenciaInput").value.trim(),
        monto: document.getElementById("montoInput").value.trim()
    };

    const constraints = {
        referencia: {
            presence: { allowEmpty: false },
            format: {
                pattern: /^\d{4}-\d{3}-\d{4}$/,
                message: "La referencia debe tener el formato XXXX-XXX-XXXX."
            }
        },
        monto: {
            presence: { allowEmpty: false },
            numericality: {
                greaterThan: 0,
                message: "El monto debe ser un número mayor a cero."
            }
        }
    };

    const errors = validate(data, constraints);

    if (errors) {
        return Swal.fire({
            icon: "error",
            title: "Error al validar",
            html: errors.referencia?.join("<br>") || errors.monto?.join("<br>")
        });
    }

    const monto = parseFloat(data.monto);

    if (monto > usuario.saldo) {
        return Swal.fire("Saldo insuficiente", "No puede pagar más de su saldo.", "error");
    }

    usuario.saldo -= monto;
    localStorage.setItem("usuario", JSON.stringify(usuario));
    document.getElementById("saldo").textContent = "$" + usuario.saldo.toFixed(2);

    Swal.fire({
        icon: "success",
        title: "Pago realizado",
        html: `
            Has pagado <b>$${monto.toFixed(2)}</b><br>
            Servicio: <b>${selectedCategory} - ${selectedCompany}</b><br>
            Referencia: <b>${data.referencia}</b>
            <br><br>
            <button id="btnPDFPago" class="btn btn-danger">Descargar PDF</button>
        `,
        showConfirmButton: false,
        didOpen: () => {
            document.getElementById("btnPDFPago").addEventListener("click", () => {
                generarPDFTransaccion(usuario, monto, "pay", {
                    categoria: selectedCategory,
                    empresa: selectedCompany,
                    referencia: data.referencia
                });
            });
        }
    });

    const modal = bootstrap.Modal.getInstance(document.getElementById('modalPago'));
    modal.hide();
}
</script>

      <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="assets/js/pdf.js"></script>

</body>
</html>
